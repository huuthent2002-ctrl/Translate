<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game D·ªãch T√™n Ri√™ng - Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .role-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }

        .role-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .role-card h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .role-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            margin: 10px 0;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin: 10px 0;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .room-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .room-code h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .code {
            font-size: 2.5em;
            font-weight: bold;
            color: #764ba2;
            letter-spacing: 5px;
        }

        .share-link {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 0.9em;
            color: #666;
        }

        .players-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .question-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .question-display h2 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            margin-top: 20px;
        }

        .answer-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .answer-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .answer-card .translation {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .answer-card .explanation {
            color: #666;
            font-style: italic;
            line-height: 1.6;
        }

        .vote-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin-top: 10px;
        }

        .vote-btn.voted {
            background: #6c757d;
        }

        .votes-count {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-ready {
            background: #d4edda;
            color: #155724;
        }

        .winner {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 3px solid #ffa500;
        }

        .setup-info {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .setup-info h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        .setup-info ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-info code {
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen" class="screen active">
            <h1>‚ö†Ô∏è C·∫ßn C·∫•u H√¨nh Firebase</h1>
            <div class="setup-info">
                <h3>üìã H∆∞·ªõng d·∫´n thi·∫øt l·∫≠p:</h3>
                <ol>
                    <li>Truy c·∫≠p <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                    <li>T·∫°o project m·ªõi (ho·∫∑c ch·ªçn project c√≥ s·∫µn)</li>
                    <li>V√†o <strong>Build ‚Üí Realtime Database ‚Üí Create Database</strong></li>
                    <li>Ch·ªçn v·ªã tr√≠ g·∫ßn nh·∫•t (Singapore) v√† b·∫Øt ƒë·∫ßu ·ªü ch·∫ø ƒë·ªô <strong>test mode</strong></li>
                    <li>V√†o <strong>Project Settings ‚Üí General ‚Üí Your apps</strong></li>
                    <li>Ch·ªçn <strong>Web app (&lt;/&gt;)</strong> v√† copy ph·∫ßn config</li>
                    <li>D√°n c√°c th√¥ng tin v√†o form d∆∞·ªõi ƒë√¢y:</li>
                </ol>
            </div>

            <input type="text" id="apiKey" placeholder="API Key (AIzaSy...)">
            <input type="text" id="authDomain" placeholder="Auth Domain (xxx.firebaseapp.com)">
            <input type="text" id="databaseURL" placeholder="Database URL (https://...firebasedatabase.app)">
            <input type="text" id="projectId" placeholder="Project ID">

            <button id="saveConfigBtn">üíæ L∆∞u c·∫•u h√¨nh v√† B·∫Øt ƒë·∫ßu</button>
        </div>

        <!-- Role Selection Screen -->
        <div id="roleScreen" class="screen">
            <h1>üéØ Game D·ªãch T√™n Ri√™ng</h1>
            <p class="subtitle">Ch·ªçn vai tr√≤ c·ªßa b·∫°n</p>

            <div class="role-selector">
                <div class="role-card" id="hostCard">
                    <h2>üé§ Ng∆∞·ªùi D·∫´n</h2>
                    <p>T·∫°o ph√≤ng v√† qu·∫£n l√Ω tr√≤ ch∆°i</p>
                </div>
                <div class="role-card" id="playerCard">
                    <h2>üéÆ Ng∆∞·ªùi Ch∆°i</h2>
                    <p>Tham gia ph√≤ng v√† ch∆°i game</p>
                </div>
            </div>
        </div>

        <!-- Host: Create Room Screen -->
        <div id="hostCreateScreen" class="screen">
            <h1>üé§ T·∫°o Ph√≤ng Ch∆°i</h1>
            
            <input type="text" id="hostName" placeholder="T√™n c·ªßa b·∫°n" value="Host">
            
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Ch·ªçn c√¢u h·ªèi:</label>
                <select id="questionSelect">
                    <option value="Harry Potter">Harry Potter</option>
                    <option value="The Lord of the Rings">The Lord of the Rings</option>
                    <option value="Spider-Man">Spider-Man</option>
                    <option value="Iron Man">Iron Man</option>
                    <option value="The Avengers">The Avengers</option>
                    <option value="Game of Thrones">Game of Thrones</option>
                    <option value="Star Wars">Star Wars</option>
                    <option value="The Matrix">The Matrix</option>
                    <option value="Frozen">Frozen</option>
                    <option value="Inception">Inception</option>
                    <option value="The Dark Knight">The Dark Knight</option>
                    <option value="Beauty and the Beast">Beauty and the Beast</option>
                </select>
            </div>

            <input type="number" id="timeLimit" placeholder="Th·ªùi gian (gi√¢y)" value="120" min="30" max="300">
            
            <button id="createRoomBtn">T·∫°o ph√≤ng</button>
            <button id="backFromCreateBtn" class="btn-secondary">‚Üê Quay l·∫°i</button>
        </div>

        <!-- Host: Waiting Room -->
        <div id="hostWaitingScreen" class="screen">
            <h1>üé§ Ph√≤ng Ch·ªù</h1>
            
            <div class="room-code">
                <h3>M√£ ph√≤ng:</h3>
                <div class="code" id="roomCodeDisplay">----</div>
                <div class="share-link" id="shareLinkDisplay">ƒêang t·∫°o link...</div>
                <button id="copyLinkBtn" style="width: auto; margin: 10px auto;">üìã Copy Link</button>
            </div>

            <div class="players-list">
                <h3 style="margin-bottom: 15px;">Ng∆∞·ªùi ch∆°i ƒë√£ tham gia: <span id="playerCount">0/2</span></h3>
                <div id="playersListHost"></div>
            </div>

            <button id="startGameBtn" disabled>B·∫Øt ƒë·∫ßu tr√≤ ch∆°i (C·∫ßn ƒë·ªß 2 ng∆∞·ªùi)</button>
            <button id="cancelRoomBtn" class="btn-danger">H·ªßy ph√≤ng</button>
        </div>

        <!-- Host: Game Playing -->
        <div id="hostPlayingScreen" class="screen">
            <h1>üéÆ ƒêang ch∆°i</h1>
            
            <div class="question-display">
                <h2 id="currentQuestion">---</h2>
                <div class="timer" id="timerDisplay">--:--</div>
            </div>

            <div class="players-list">
                <h3 style="margin-bottom: 15px;">Tr·∫°ng th√°i ng∆∞·ªùi ch∆°i:</h3>
                <div id="playersStatusHost"></div>
            </div>

            <button id="endAnsweringBtn">‚è≠Ô∏è K·∫øt th√∫c nh·∫≠p ƒë√°p √°n</button>
        </div>

        <!-- Host: Results & Voting -->
        <div id="hostResultsScreen" class="screen">
            <h1>üìä K·∫øt Qu·∫£ & B√¨nh Ch·ªçn</h1>
            
            <div class="question-display" style="padding: 20px;">
                <h3 style="margin-bottom: 10px;">C√¢u h·ªèi:</h3>
                <h2 id="questionResults">---</h2>
            </div>

            <div id="answersDisplay"></div>

            <button id="showResultsBtn" class="btn-success">üèÜ Xem k·∫øt qu·∫£ cu·ªëi c√πng</button>
        </div>

        <!-- Host: Final Results -->
        <div id="hostFinalScreen" class="screen">
            <h1>üèÜ K·∫øt Qu·∫£ Cu·ªëi C√πng</h1>
            
            <div id="finalResultsDisplay"></div>

            <button id="newGameBtn">üîÑ Ch∆°i l·∫°i</button>
            <button id="backToRoleFromFinalBtn" class="btn-secondary">‚Üê V·ªÅ trang ch·ªß</button>
        </div>

        <!-- Player: Join Room -->
        <div id="playerJoinScreen" class="screen">
            <h1>üéÆ Tham Gia Ph√≤ng</h1>
            
            <input type="text" id="playerName" placeholder="T√™n c·ªßa b·∫°n">
            <input type="text" id="roomCode" placeholder="M√£ ph√≤ng (4 s·ªë)">
            
            <button id="joinRoomBtn">Tham gia</button>
            <button id="backFromJoinBtn" class="btn-secondary">‚Üê Quay l·∫°i</button>
        </div>

        <!-- Player: Waiting -->
        <div id="playerWaitingScreen" class="screen">
            <h1>‚è≥ ƒêang Ch·ªù...</h1>
            <p class="subtitle">Ch·ªù ng∆∞·ªùi d·∫´n b·∫Øt ƒë·∫ßu tr√≤ ch∆°i</p>

            <div class="players-list">
                <h3 style="margin-bottom: 15px;">Ng∆∞·ªùi ch∆°i trong ph√≤ng:</h3>
                <div id="playersListPlayer"></div>
            </div>

            <button id="leaveRoomBtn" class="btn-danger">R·ªùi ph√≤ng</button>
        </div>

        <!-- Player: Answer -->
        <div id="playerAnswerScreen" class="screen">
            <h1>‚úçÔ∏è Tr·∫£ L·ªùi</h1>
            
            <div class="question-display">
                <h2 id="playerQuestion">---</h2>
                <div class="timer" id="playerTimer">--:--</div>
            </div>

            <input type="text" id="playerTranslation" placeholder="B·∫£n d·ªãch c·ªßa b·∫°n">
            <textarea id="playerExplanation" placeholder="Gi·∫£i th√≠ch t·∫°i sao b·∫°n ch·ªçn b·∫£n d·ªãch n√†y..."></textarea>

            <button id="submitAnswerBtn">G·ª≠i c√¢u tr·∫£ l·ªùi</button>
        </div>

        <!-- Player: Submitted -->
        <div id="playerSubmittedScreen" class="screen">
            <h1>‚úÖ ƒê√£ G·ª≠i</h1>
            <p class="subtitle">Ch·ªù ng∆∞·ªùi ch∆°i kh√°c ho√†n th√†nh...</p>

            <div class="answer-card">
                <h4>B·∫£n d·ªãch c·ªßa b·∫°n:</h4>
                <div class="translation" id="submittedTranslation">---</div>
                <div class="explanation" id="submittedExplanation">---</div>
            </div>
        </div>

        <!-- Player: Voting -->
        <div id="playerVotingScreen" class="screen">
            <h1>üó≥Ô∏è B√¨nh Ch·ªçn</h1>
            <p class="subtitle">Ch·ªçn b·∫£n d·ªãch hay nh·∫•t (kh√¥ng ƒë∆∞·ª£c vote cho m√¨nh)</p>

            <div id="votingOptions"></div>
        </div>

        <!-- Player: Final Results -->
        <div id="playerFinalScreen" class="screen">
            <h1>üèÜ K·∫øt Qu·∫£</h1>
            
            <div id="playerFinalResults"></div>

            <button id="backToRoleFromPlayerFinalBtn" class="btn-secondary">‚Üê V·ªÅ trang ch·ªß</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        let app, database;
        let currentRole = null;
        let currentRoomId = null;
        let currentPlayerId = null;
        let playerName = '';
        let timerInterval = null;

        // Helper functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Setup Firebase
        document.getElementById('saveConfigBtn').addEventListener('click', () => {
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                authDomain: document.getElementById('authDomain').value.trim(),
                databaseURL: document.getElementById('databaseURL').value.trim(),
                projectId: document.getElementById('projectId').value.trim()
            };

            if (!config.apiKey || !config.databaseURL) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin Firebase!');
                return;
            }

            try {
                app = initializeApp(config);
                database = getDatabase(app);
                
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                showScreen('roleScreen');
                alert('‚úÖ K·∫øt n·ªëi Firebase th√†nh c√¥ng!');
            } catch (error) {
                alert('‚ùå L·ªói k·∫øt n·ªëi Firebase: ' + error.message);
            }
        });

        // Check for saved config on load
        window.addEventListener('load', () => {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    app = initializeApp(config);
                    database = getDatabase(app);
                    showScreen('roleScreen');
                } catch (error) {
                    console.log('C·∫ßn c·∫•u h√¨nh Firebase m·ªõi');
                }
            }

            // Check for room code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomCodeFromUrl = urlParams.get('room');
            if (roomCodeFromUrl) {
                document.getElementById('roomCode').value = roomCodeFromUrl;
            }
        });

        // Role Selection
        document.getElementById('hostCard').addEventListener('click', () => {
            currentRole = 'host';
            showScreen('hostCreateScreen');
        });

        document.getElementById('playerCard').addEventListener('click', () => {
            currentRole = 'player';
            showScreen('playerJoinScreen');
        });

        // Back to role selection
        function backToRole() {
            if (timerInterval) clearInterval(timerInterval);
            if (currentRoomId && currentPlayerId) {
                remove(ref(database, `rooms/${currentRoomId}/players/${currentPlayerId}`));
            }
            currentRoomId = null;
            currentPlayerId = null;
            showScreen('roleScreen');
        }

        document.getElementById('backFromCreateBtn').addEventListener('click', backToRole);
        document.getElementById('backFromJoinBtn').addEventListener('click', backToRole);
        document.getElementById('backToRoleFromFinalBtn').addEventListener('click', backToRole);
        document.getElementById('backToRoleFromPlayerFinalBtn').addEventListener('click', backToRole);

        // HOST: Create Room
        document.getElementById('createRoomBtn').addEventListener('click', () => {
            const hostNameInput = document.getElementById('hostName').value.trim();
            const question = document.getElementById('questionSelect').value;
            const timeLimit = parseInt(document.getElementById('timeLimit').value);

            if (!hostNameInput) {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
                return;
            }

            playerName = hostNameInput;
            const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
            currentRoomId = roomCode;

            const roomData = {
                code: roomCode,
                host: playerName,
                question: question,
                timeLimit: timeLimit,
                status: 'waiting',
                createdAt: Date.now()
            };

            set(ref(database, `rooms/${roomCode}`), roomData).then(() => {
                document.getElementById('roomCodeDisplay').textContent = roomCode;
                const shareLink = `${window.location.href.split('?')[0]}?room=${roomCode}`;
                document.getElementById('shareLinkDisplay').textContent = shareLink;
                
                showScreen('hostWaitingScreen');
                listenToPlayers();
            });
        });

        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            const link = document.getElementById('shareLinkDisplay').textContent;
            navigator.clipboard.writeText(link);
            alert('‚úÖ ƒê√£ copy link!');
        });

        // Listen to players joining
        function listenToPlayers() {
            const playersRef = ref(database, `rooms/${currentRoomId}/players`);
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val() || {};
                const playerCount = Object.keys(players).length;
                
                let html = '';
                Object.entries(players).forEach(([id, player]) => {
                    html += `
                        <div class="player-item">
                            <div class="player-icon">${player.name.charAt(0).toUpperCase()}</div>
                            <div style="flex: 1;">
                                <strong>${player.name}</strong>
                                ${player.status ? `<span class="status-badge status-${player.status}">${player.status === 'ready' ? '‚úì ƒê√£ tr·∫£ l·ªùi' : '‚è≥ ƒêang suy nghƒ©'}</span>` : ''}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('playersListHost').innerHTML = html || '<p style="text-align: center; color: #999;">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o...</p>';
                if (document.getElementById('playersListPlayer')) {
                    document.getElementById('playersListPlayer').innerHTML = html;
                }
                
                document.getElementById('startGameBtn').disabled = playerCount < 1;
            });
        }

        // HOST: Start Game
        document.getElementById('startGameBtn').addEventListener('click', () => {
            update(ref(database, `rooms/${currentRoomId}`), {
                status: 'playing',
                startTime: Date.now()
            });

            showScreen('hostPlayingScreen');
            displayQuestion();
            startTimer();
            listenToAnswers();
        });

        document.getElementById('cancelRoomBtn').addEventListener('click', () => {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ph√≤ng?')) {
                remove(ref(database, `rooms/${currentRoomId}`));
                backToRole();
            }
        });

        function displayQuestion() {
            get(ref(database, `rooms/${currentRoomId}/question`)).then((snapshot) => {
                const question = snapshot.val();
                document.getElementById('currentQuestion').textContent = question;
                if (document.getElementById('playerQuestion')) {
                    document.getElementById('playerQuestion').textContent = question;
                }
                if (document.getElementById('questionResults')) {
                    document.getElementById('questionResults').textContent = question;
                }
            });
        }

        function startTimer() {
            get(ref(database, `rooms/${currentRoomId}`)).then((snapshot) => {
                const room = snapshot.val();
                let timeLeft = room.timeLimit;

                timerInterval = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (document.getElementById('timerDisplay')) {
                        document.getElementById('timerDisplay').textContent = display;
                    }
                    if (document.getElementById('playerTimer')) {
                        document.getElementById('playerTimer').textContent = display;
                    }

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        if (currentRole === 'host') {
                            endAnswering();
                        }
                    }
                }, 1000);
            });
        }

        function listenToAnswers() {
            const answersRef = ref(database, `rooms/${currentRoomId}/answers`);
            onValue(answersRef, (snapshot) => {
                const answers = snapshot.val() || {};
                
                get(ref(database, `rooms/${currentRoomId}/players`)).then((playersSnap) => {
                    const players = playersSnap.val() || {};
                    
                    let html = '';
                    Object.entries(players).forEach(([id, player]) => {
                        const hasAnswered = answers[id];
                        html += `
                            <div class="player-item">
                                <div class="player-icon">${player.name.charAt(0).toUpperCase()}</div>
                                <div style="flex: 1;">
                                    <strong>${player.name}</strong>
                                    <span class="status-badge ${hasAnswered ? 'status-ready' : 'status-waiting'}">
                                        ${hasAnswered ? '‚úì ƒê√£ tr·∫£ l·ªùi' : '‚è≥ ƒêang suy nghƒ©...'}
                                    </span>
                                </div>
                            </div>
                        `;
                    });

                    document.getElementById('playersStatusHost').innerHTML = html;
                });
            });
        }

        // HOST: End Answering Phase
        document.getElementById('endAnsweringBtn').addEventListener('click', endAnswering);

        function endAnswering() {
            if (timerInterval) clearInterval(timerInterval);
            
            update(ref(database, `rooms/${currentRoomId}`), {
                status: 'voting'
            });

            showScreen('hostResultsScreen');
            displayAnswersForVoting();
        }

        function displayAnswersForVoting() {
            get(ref(database, `rooms/${currentRoomId}`)).then((snapshot) => {
                const room = snapshot.val();
                const answers = room.answers || {};
                const players = room.players || {};

                let html = '';
                Object.entries(answers).forEach(([playerId, answer]) => {
                    html += `
                        <div class="answer-card" id="answer-${playerId}">
                            <h4>üë§ ${players[playerId]?.name || 'Ng∆∞·ªùi ch∆°i'}</h4>
                            <div class="translation">${answer.translation}</div>
                            <div class="explanation">"${answer.explanation}"</div>
                            <div class="votes-count" id="votes-${playerId}">0 phi·∫øu b·∫ßu</div>
                        </div>
                    `;
                });

                document.getElementById('answersDisplay').innerHTML = html || '<p style="text-align: center; color: #999;">Ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi n√†o...</p>';
                
                listenToVotes();
            });
        }

        function listenToVotes() {
            const votesRef = ref(database, `rooms/${currentRoomId}/votes`);
            onValue(votesRef, (snapshot) => {
                const votes = snapshot.val() || {};
                const voteCounts = {};

                Object.values(votes).forEach(votedFor => {
                    voteCounts[votedFor] = (voteCounts[votedFor] || 0) + 1;
                });

                Object.keys(voteCounts).forEach(playerId => {
                    const voteEl = document.getElementById(`votes-${playerId}`);
                    if (voteEl) {
                        voteEl.textContent = `‚≠ê ${voteCounts[playerId]} phi·∫øu b·∫ßu`;
                    }
                });
            });
        }

        // HOST: Show Final Results
        document.getElementById('showResultsBtn').addEventListener('click', showFinalResults);

        function showFinalResults() {
            get(ref(database, `rooms/${currentRoomId}`)).then((snapshot) => {
                const room = snapshot.val();
                const answers = room.answers || {};
                const players = room.players || {};
                const votes = room.votes || {};

                const voteCounts = {};
                Object.values(votes).forEach(votedFor => {
                    voteCounts[votedFor] = (voteCounts[votedFor] || 0) + 1;
                });

                const sorted = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);

                let html = '';
                sorted.forEach(([playerId, voteCount], index) => {
                    const answer = answers[playerId];
                    const player = players[playerId];
                    const isWinner = index === 0;

                    html += `
                        <div class="answer-card ${isWinner ? 'winner' : ''}">
                            ${isWinner ? '<h3 style="color: #ff6b00; margin-bottom: 10px;">üèÜ CHI·∫æN TH·∫ÆNG!</h3>' : ''}
                            <h4>#${index + 1} - üë§ ${player?.name || 'Ng∆∞·ªùi ch∆°i'}</h4>
                            <div class="translation">${answer?.translation || 'N/A'}</div>
                            <div class="explanation">"${answer?.explanation || 'N/A'}"</div>
                            <div class="votes-count">‚≠ê ${voteCount} phi·∫øu b·∫ßu</div>
                        </div>
                    `;
                });

                document.getElementById('finalResultsDisplay').innerHTML = html;
                document.getElementById('playerFinalResults').innerHTML = html;

                update(ref(database, `rooms/${currentRoomId}`), {
                    status: 'finished'
                });

                showScreen('hostFinalScreen');
            });
        }

        // HOST: New Game
        document.getElementById('newGameBtn').addEventListener('click', () => {
            if (confirm('B·∫°n c√≥ mu·ªën t·∫°o ph√≤ng m·ªõi?')) {
                remove(ref(database, `rooms/${currentRoomId}`));
                backToRole();
            }
        });

        // PLAYER: Join Room
        document.getElementById('joinRoomBtn').addEventListener('click', () => {
            const name = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim();

            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
                return;
            }

            if (!roomCode || roomCode.length !== 4) {
                alert('Vui l√≤ng nh·∫≠p m√£ ph√≤ng 4 s·ªë!');
                return;
            }

            playerName = name;
            currentRoomId = roomCode;

            // Check if room exists
            get(ref(database, `rooms/${roomCode}`)).then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('Ph√≤ng kh√¥ng t·ªìn t·∫°i!');
                    return;
                }

                const room = snapshot.val();
                if (room.status !== 'waiting') {
                    alert('Ph√≤ng ƒë√£ b·∫Øt ƒë·∫ßu ch∆°i!');
                    return;
                }

                // Add player to room
                currentPlayerId = generateId();
                set(ref(database, `rooms/${roomCode}/players/${currentPlayerId}`), {
                    id: currentPlayerId,
                    name: name,
                    joinedAt: Date.now()
                }).then(() => {
                    showScreen('playerWaitingScreen');
                    listenToPlayers();
                    listenToRoomStatus();
                });
            });
        });

        document.getElementById('leaveRoomBtn').addEventListener('click', () => {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi ph√≤ng?')) {
                remove(ref(database, `rooms/${currentRoomId}/players/${currentPlayerId}`));
                backToRole();
            }
        });

        // PLAYER: Listen to room status
        function listenToRoomStatus() {
            const statusRef = ref(database, `rooms/${currentRoomId}/status`);
            onValue(statusRef, (snapshot) => {
                const status = snapshot.val();
                
                if (status === 'playing') {
                    showScreen('playerAnswerScreen');
                    displayQuestion();
                    startTimer();
                } else if (status === 'voting') {
                    showScreen('playerVotingScreen');
                    displayVotingOptions();
                } else if (status === 'finished') {
                    showScreen('playerFinalScreen');
                    showFinalResults();
                } else if (status === null) {
                    alert('Ph√≤ng ƒë√£ b·ªã ƒë√≥ng!');
                    backToRole();
                }
            });
        }

        // PLAYER: Submit Answer
        document.getElementById('submitAnswerBtn').addEventListener('click', () => {
            const translation = document.getElementById('playerTranslation').value.trim();
            const explanation = document.getElementById('playerExplanation').value.trim();

            if (!translation || !explanation) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß b·∫£n d·ªãch v√† gi·∫£i th√≠ch!');
                return;
            }

            set(ref(database, `rooms/${currentRoomId}/answers/${currentPlayerId}`), {
                translation: translation,
                explanation: explanation,
                submittedAt: Date.now()
            }).then(() => {
                document.getElementById('submittedTranslation').textContent = translation;
                document.getElementById('submittedExplanation').textContent = explanation;
                showScreen('playerSubmittedScreen');
            });
        });

        // PLAYER: Display voting options
        function displayVotingOptions() {
            get(ref(database, `rooms/${currentRoomId}`)).then((snapshot) => {
                const room = snapshot.val();
                const answers = room.answers || {};
                const players = room.players || {};

                let html = '';
                Object.entries(answers).forEach(([playerId, answer]) => {
                    if (playerId === currentPlayerId) return; // Can't vote for yourself

                    html += `
                        <div class="answer-card">
                            <h4>üë§ ${players[playerId]?.name || 'Ng∆∞·ªùi ch∆°i'}</h4>
                            <div class="translation">${answer.translation}</div>
                            <div class="explanation">"${answer.explanation}"</div>
                            <button class="vote-btn" onclick="voteFor('${playerId}')">üó≥Ô∏è Vote cho b·∫£n d·ªãch n√†y</button>
                        </div>
                    `;
                });

                document.getElementById('votingOptions').innerHTML = html || '<p style="text-align: center; color: #999;">Kh√¥ng c√≥ ƒë√°p √°n n√†o ƒë·ªÉ vote...</p>';
            });
        }

        // PLAYER: Vote
        window.voteFor = function(playerId) {
            set(ref(database, `rooms/${currentRoomId}/votes/${currentPlayerId}`), playerId).then(() => {
                alert('‚úÖ ƒê√£ b√¨nh ch·ªçn!');
                
                // Disable all vote buttons
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('voted');
                    btn.textContent = '‚úì ƒê√£ b√¨nh ch·ªçn';
                });
            });
        };
    </script>
</body>
</html>
